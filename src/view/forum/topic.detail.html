#parse('/forum/head.html')

<div id='title'>
	<div class="blue-wrap">
		<div class="container">
			<div class="row">	
				<div class="col-sm-8">
					<h1>Topic detail</h1>
				</div>
			</div>
		</div>
	</div>	
</div>

<div class='tabs'>
	<div class='pull-left'>
		<a href='/forum'>$lang.get('circling.index.title')</a>
		<span>&gt;</span>
		<a href='/forum/topic?cid=$!cid'>$lang.get('topic.index.title')</a>
		<span>&gt;</span>
		<a href='/forum/topic/detail?id=$!t.id'>$!t.title</a>
	</div>
	<div class='pull-right'>
		<a>new</a>
		<a>reply</a>
	</div>
</div>

<div class='col-sm-12 topic'>
	<div class='topic-summary'>
		<strong><a href='/forum/topic?cid=$!cid'>$!c.name</a></strong>&nbsp;&gt;&nbsp;<span>$!t.title</span>
		<div class='pull-right'>
			<span>$lang.get('topic.reads'):$t.reads</span>
			<span>|</span>
			<span>$lang.get('topic.replies'):$t.replies</span>
		</div>
	</div>
	
	<div class='col-sm-12 topic-f0'>
		#set($o = $t.owner_obj)
		#parse('/forum/topic.owner.html')
		#set($f=$t)
		#parse('/forum/topic.content.html')
	</div>
	#foreach($f in $list)
	<div class='col-sm-12 topic-fn'>
		#set($o = $t.owner_obj)
		#parse('/forum/topic.owner.html')
		#parse('/forum/topic.content.html')
	</div>
	#end
	
	<table class="table table-hover">
		<thead>
			<tr>
				<th class="col-sm-2"></th>
				<th class="col-sm-10">
					$!t.title
					#if($me.id == $c.owner)
					<a class="btn" href="javascript:;" onclick="_delete('$t.id', 1, this)">delete</a>
					#end
				</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td> 
					<a href="/forum/circling?uid=$t.owner">$!t.owner_obj.nickname</a> 
					#if($me.id==$c.owner && $me.id != $t.owner)
					<div>
						<a href="javascript:;" onclick="_deny('$cid','$f.owner')">deny</a> 
					</div>
					#end
				</td>
				<td>
					<div class='col-sm-12 content'>$!t.content</div>
					<div class="col-sm-12">
						#if(!$c.isForbidden($me))
						<a class="btn" href="javascript:;" onclick="_showreply('')">reply</a>
						#end
						#if($me.id == $t.owner)
						<a class="btn" href="/forum/topic/edit?id=$t.id">edit</a>
						#end
					</div>
				</td>
			</tr>
			#foreach($f in $list)
			<tr>
				<td> 
					<div>
						<a href="/forum/circling?uid=$f.owner">$!f.owner_obj.nickname</a> 
					</div>
					#if($me.id==$c.owner && $me.id != $f.owner)
					<div>
						<a href="javascript:;" onclick="_deny('$cid','$f.owner')">deny</a> 
					</div>
					#end
				</td>
				<td>
					<div class="col-sm-12 content">
						#if($f.refer)
						#set($r=$f.refer)
						$this.toHtml($r)
						#end
						#if($f.deleted == 1)
						<div class='col-sm-12 content'>$lang.get('topic.was.deleted')</div>
						#else
						<div class='col-sm-12 content'>$!f.content</div>
						#end
					</div>
					<div class="col-sm-12">
						#if(!$c.isForbidden($me))
						<a class="btn" href="javascript:;" onclick="_showreply('$f.id', '$f.owner_obj.nickname')">reply</a>
						#end
						#if($me.id == $c.owner)
							#if($f.deleted==1)
							<a class="btn" href="javascript:;" onclick="_delete('$f.id', 0, this)">recover</a>
							#else
							<a class="btn" href="javascript:;" onclick="_delete('$f.id', 1, this)">delete</a>
							#end
						#end
					</div>
				</td>
			</tr>
			#end
		</tbody>
	</table>
	
	#parse('/forum/goto.page.html')
	
	<div id='reply' class="col-sm-12">
		<form class="form-horizontal" method="post" action="/forum/topic/reply">
		  <input type='hidden' name='id' value='$!t.id' />
		  <input type='hidden' name='refer' value='' />
		  <div class="form-group">
		    <label for="content" class="col-sm-2 control-label">$lang.get('topic.reply')</label>
		    <div class="col-sm-10">
		      <textarea class="form-control" name="content" id="content">$!content</textarea>
		    </div>
		  </div>
		
		  <div class="form-group">
		    <div class="col-sm-offset-2 col-sm-10">
		      <button class="btn btn-primary" onclick="_reply()">$lang.get('btn.ok')</button>
		    </div>
		  </div>
		</form>
	</div>
</div>
<ul class='col-sm-3 recommends'>
	#foreach($f in $recommends)
	<li><a href="/forum/topic/detail?id=$f.id">$f.title</a></li>
	#end
</ul>

<script>
function _deny(cid, uid) {
	processing && processing.show();
	$.post('/forum/circling/deny', {cid:cid, uid:uid}, function(d){
		processing && processing.hide();
		$.success(d.messsage);
	})
}
function _delete(id, flag, o) {
	processing && processing.show();
	$.post('/forum/topic/update', {cid:'$cid', id:id, deleted:flag}, function(d){
		processing && processing.hide();
		$(o).parent().parent().html(d);
	})
}
function _showreply(refer, o){
	$('#reply input[name=refer]').val(refer);
	var e = $('#reply label[for=content]');
	if(refer.length > 0) {
		e.html('@' + o);
	} else {
		e.html("$lang.get('topic.reply')");
	}
	editor.html('');
	
	//smoothscroll to #reply
	
}
var editor = false;
$(function(){
	editor = KindEditor.create('textarea[name="content"]', {
			basePath : '/ke/',
			resizeType : 1,
			allowPreviewEmoticons : false,
			allowImageUpload : true,
			items : ['fontname', 'fontsize', '|', 'forecolor',
					'hilitecolor', 'bold', 'italic', 'underline',
					'removeformat', '|', 'justifyleft', 'justifycenter',
					'justifyright', 'insertorderedlist',
					'insertunorderedlist', '|', 'emoticons', 'image',
					'link']
		});	
})
</script>

#parse('/forum/foot.html')
